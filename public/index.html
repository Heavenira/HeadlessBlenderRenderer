<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/buefy/dist/buefy.min.css">
    <title>Blender Render (& Cycles)</title>
    <link rel="stylesheet" href="//cdn.materialdesignicons.com/3.6.95/css/materialdesignicons.min.css">
</head>

<body>
<div id="app">
    <div class="container ">
        <p class="title is-1">Blender Rendering</p>
        <p class="subtitle is-4">Socket <span v-html="getSocketStatus"></span></p>
        <div class="columns">
            <div class="column is-6">
                <span v-if="!render.active">
                <b-field class="file">
                    <a :disabled="!socket_status" @click="blend_chooser.active = true;refreshBlendChooser()" class="button is-primary">
                        <b-icon icon="file"></b-icon>
                        <span>Choose a blend file</span>
                    </a>
                    <span class="file-name" v-if="blend">
                        {{ blend }}
                    </span>
                </b-field>
                <b-field label="Render Options">
                    <b-checkbox v-model="opts.blend.gpu_render">
                        Render with {{opts.blend.gpu_render?"GPU":"CPU"}}
                    </b-checkbox>
                </b-field>
                <b-field label="Frame Options">
                    <b-checkbox v-model="opts.blend.all_frames">
                        Render all frames
                    </b-checkbox>
                </b-field>
                <span v-if="!opts.blend.all_frames">
                    <b-field label="Starting Frame">
                            <b-numberinput :min="0" :max="opts.blend.frame_stop" :disabled="opts.blend.all_frames" v-model="opts.blend.frame_start"></b-numberinput>
                    </b-field>
                    <b-field label="Ending Frame">
                        <b-numberinput :min="opts.blend.frame_start>0?opts.blend.frame_start:0" :disabled="opts.blend.all_frames" v-model="opts.blend.frame_stop"></b-numberinput>
                    </b-field>
                    <br>
                </span>
                <b-field label="Python Scripts (Optional)">
                    <b-taginput
                        v-model="opts.blend.py_scripts"
                        type="is-dark">
                    </b-taginput>
                </b-field>
                <b-field label="Extra Command Arguments (Optional)">
                    <b-input
                        v-model="opts.blend.extra_args">
                    </b-input>
                </b-field>
                <span v-if="blend != null">
                <br>
                <b>Command:</b> {{generateCommand()}}
                <br>
                </span>
                <br>
                </span>
                <div class="notification is-dark">
                    <div v-if="render.active">
                        <div><strong class="is-white">A render is currently in progress ({{render.current}}/{{render.max}}) - {{framePercent}}</strong></div>
                        <br>
                        <progress class="progress" :value='render.current' :max='render.max'></progress>
                        <br>
                    </div>
                    <nav class="navbar is-dark">
                        <div class="navbar-menu">
                            <div class="navbar-start">
                                <div class="buttons">
                                    <b-button :disabled="render.active||blend==null||!socket_status" type="is-success" @click="startRender()">
                                        Render
                                    </b-button>
                                    <b-button :disabled="!socket_status" type="is-danger" outlined @click="cancelRender()">
                                        Stop
                                    </b-button>
                                </div>
                            </div>
                            <div class="navbar-end">
                                <div class="buttons">
                                    <b-button @click="saveDefaults">
                                        <b-icon icon="content-save"></b-icon><span>Save Defaults</span>
                                    </b-button>
                                </div>
                            </div>
                        </div>    
                    </nav>
                </div>
                <b-field>
                    <a :disabled="!socket_status" @click="zips.active = true;refreshZIPs()" class="button is-large is-fullwidth is-info">
                        <b-icon icon="download"></b-icon>
                        <span>Download ZIPs</span>
                    </a>
                </b-field>
            </div>
            <div class="column is-6">
                <b-field label="Console Output">
                    <b-input :disabled="!socket_status" id="el_renderlog" type="textarea" v-model="render.logs" readonly rows=10></b-input>
                </b-field>
                <hr>
                <h5 class="title is-5">Options</h5>
                <!-- <b-field expanded>
                    <b-select placeholder="Update Interval" v-model="opts.stat.update_interval" label="Update Interval">
                        <option value=15>Update every 15 seconds</option>
                        <option value=30>Update every 30 seconds</option>
                        <option value=45>Update every 45 seconds</option>
                        <option value=60>Update every 60 seconds</option>
                    </b-select>
                </b-field> -->
                <b-field expanded>
                    <b-checkbox v-model="opts.stat.celsius">
                        Use Celsius
                    </b-checkbox>
                </b-field>
                <hr>
                <span v-if="!socket_status">
                    <div v-if="!socket_status" class="notification is-danger">
                        Lost Connection to the Socket Server.
                    </div>
                </span>
                <span v-else>
                <b-field :label="'CPU Stats - ' + (stats.cpu.name?stats.cpu.name:'Unknown')">
                    
                    <nav :loading="stats.initial" class="level">
                        <div class="level-item has-text-centered">
                            <div>
                            <p class="heading">CPU %</p>
                            <p class="title">{{stats.cpu.usage}}%</p>
                            </div>
                        </div>
                        <div class="level-item has-text-centered">
                            <div>
                            <p class="heading">CPU Temp</p>
                            <p class="title">{{cm_temp(stats.cpu.temp)}}</p>
                            </div>
                        </div>
                        <div class="level-item has-text-centered">
                            <div>
                            <p class="heading">CPU Speed</p>
                            <p class="title">{{stats.cpu.speed}} GHz</p>
                            </div>
                        </div>
                    </nav>
                </b-field>
                <b-field label="GPU Stats" v-if="stats.gpu.length == 0">
                    No GPU found.
                </b-field>
                <b-field v-for="(gpu,index) in stats.gpu" :key="index" :label="'GPU #' + ++index + ' Stats - ' + gpu.name">
                    
                    <nav class="level">
                        <b-loading :is-full-page="false" :active="stats.initial"></b-loading>
                        <div class="level-item has-text-centered">
                            <div>
                            <p class="heading">GPU %</p>
                            <p class="title">{{(gpu.usage>-1)?`${gpu.usage}%`:'n/a'}}</p>
                            </div>
                        </div>
                        <div class="level-item has-text-centered">
                            <div>
                            <p class="heading">GPU Temp</p>
                            <p class="title">{{cm_temp(gpu.temp)}}</p>
                            </div>
                        </div>
                        <div class="level-item has-text-centered">
                            <div>
                            <p class="heading">GPU MEM</p>
                            <p class="title">{{gpu.vram.current>-1?`${cm_vram(gpu.vram.current,true)}/${cm_vram(gpu.vram.max,true)}`:'n/a'}}</p>
                            </div>
                        </div>
                    </nav>
                </b-field>
                </span>
            </div>
        </div>
        <br>
    </div>
    <b-modal :active.sync="blend_chooser.active">
        <div class="box">
            <h3 class='title is-3'>Blend File Chooser</h3>
            <b-loading :is-full-page="false" :active.sync="blend_chooser.loading||!socket_status"></b-loading>
            <p v-if="blend_chooser.blends == null">Loading blends...</p>
            <div v-if="!socket_status" class="notification is-danger">
               Lost Connection to the Socket Server.
            </div>
            <h5 class="title is-5">Existing Blend Files <a @click='refreshBlendChooser' class="button is-info is-small"><b-icon icon="refresh"></b-icon><span>Refresh</span></a></h5>
            <b-table
            :data="blend_chooser.blends||[]"
            :striped="true"
            :hoverable="true"
            :loading="blend_chooser.blends == null">

            <template slot-scope="props">
                <b-table-column field="name" label="Name">
                    {{ props.row.name }}
                </b-table-column>

                <b-table-column label="Action">
                    <a :disabled="!socket_status" @click="chooseBlend(props.row.name)" class="button is-primary is-small">Use</a>
                </b-table-column>

            </template>

            <template slot="empty">
                <section class="section">
                    <div class="content has-text-grey has-text-centered">
                        <p>
                            <b-icon
                                icon="emoticon-sad"
                                size="is-large">
                            </b-icon>
                        </p>
                        <p>Nothing here.</p>
                    </div>
                </section>
            </template>
            </b-table>
            <hr>
            <h5 class="title is-5">Upload Blend Files</h5>
            <b-field>
                <b-upload :disabled="!socket_status" id="uploader" v-model="blend_chooser.uploads"
                    multiple
                    accept=".blend"
                    drag-drop>
                    <section class="section">
                        <div class="content has-text-centered">
                            <p>
                                <b-icon
                                    icon="upload"
                                    size="is-large">
                                </b-icon>
                            </p>
                            <p>Drop your files here or click to upload</p>
                        </div>
                    </section>
                </b-upload>
            </b-field>
    
            <div class="tags">
                <span v-for="(file, index) in blend_chooser.uploads"
                    :key="index"
                    class="tag is-primary" >
                    {{file.name}}
                    <button class="delete is-small"
                        type="button"
                        @click="deleteDropFile(index)">
                    </button>
                </span>
            </div>
            <span v-if="blend_chooser.uploading">
                <progress v-for="upload in blend_chooser.uploads" class="progress" :value="upload.progress" max="100"></progress>
            </span>
            
            <b-field>
                <b-button @click='uploadFiles' :disabled="blend_chooser.uploads.length == 0||!socket_status" type="button is-success">Upload Files</button>
            </b-field>
        </div>
    </b-modal>
    <b-modal :active.sync="zips.active">
        <div class="box">
            <h3 class='title is-3'>Download ZIPs <a @click='refreshZIPs' class="button is-info"><b-icon icon="refresh"></b-icon><span>Refresh</span></a></h3>
            <b-loading :is-full-page="false" :active.sync="zips.loading||!socket_status"></b-loading>
            <p v-if="zips.list == null">Loading zips...</p>
            <div v-if="!socket_status" class="notification is-danger">
                Lost Connection to the Socket Server.
             </div>
            <b-table
            :data="zips.list||[]"
            :striped="true"
            :hoverable="true"
            :loading="zips.list == null">

            <template slot-scope="props">
                <b-table-column field="name" label="Name">
                    {{ props.row.name }}
                </b-table-column>

                <b-table-column label="Action">
                    <a :disabled="!socket_status" @click="downloadZip(props.row.name)" class="button is-primary is-small">Download</a>
                    <a :disabled="!socket_status" @click="deleteZip(props.row.name)" class="button is-danger is-small"><b-icon icon="delete"></b-icon></a>
                </b-table-column>

            </template>

            <template slot="empty">
                <section class="section">
                    <div class="content has-text-grey has-text-centered">
                        <p>
                            <b-icon
                                icon="emoticon-sad"
                                size="is-large">
                            </b-icon>
                        </p>
                        <p>Nothing here.</p>
                    </div>
                </section>
            </template>
            </b-table>
        </div>
    </b-modal>
</div>
<script src="https://unpkg.com/vue"></script>
<script src="https://unpkg.com/buefy/dist/buefy.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="socket.io/socket.io.js"></script>
<script src="socket.io-file-client.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.8/download.min.js" integrity="sha256-k77iqKeo6Og1Lf5mawux2rTxjaV9zUtyOWKVX3VttKE=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
<script>
const params = new Map(location.search.slice(1).split('&').map(kv => kv.split('=')))
let socket, uploader;
var app = new Vue({
    el: '#app',
    data:{
        socket_status:false,
        blend_chooser:{
            progress:0,
            uploading:false,
            active:false,
            loading:true,
            blends:null,
            uploads:[]
        },
        zips:{
            loading:true,
            active:false,
            list:null
        },
        render:{
            logs:"",
            active:false,
            current:0,
            max:0
        },
        blend:null,
        stats:{
            initial:true,
            cpu:{
                usage:0,
                speed:0,
                temp:0,
                fan_speed:0,
            },
            gpu:[]
        },
        opts:{
            blend:{
                gpu_render:true,
                all_frames:true,
                frame_start:0,
                frame_stop:0,
                py_scripts:[],
                extra_args:""
            },
            stat:{
                update_interval:30,
                celsius:false
            }
        }
    },
    computed:{
        framePercent() {
            return Math.round(this.render.current/this.render.max*100) + "%";
        },
        getSocketStatus() {
            if(this.socket_status) {
                return `<span class='has-text-success'>Connected</span>`
            }else{
                return `<span class='has-text-danger'>Disconnected</span>`
            }
        }
    },
    created:function() {
        let domain = params.has('sk_domain') ? params.get('sk_domain') : 'localhost'
        let port = params.has('sk_port') ? params.get('sk_port') : '8095'
        socket = io.connect(`//${domain}:${port}`);
        uploader = new SocketIOFileClient(socket);
        if(window.localStorage) {
            const opts = window.localStorage.getItem('blender_opts');
            if(opts) {
                this.opts = JSON.parse(opts);
            }
        }else{
            console.warn('Browser does not support localStorage, defaults wont be loaded.')
        }
    },
    mounted() {
        //this.fetchStats();
        uploader.on('start', fileInfo => {
            this.blend_chooser.uploading = true;
            this.blend_chooser.progress = 0;
            console.log('Uploading file',fileInfo.name);
        });
        uploader.on('stream', (fileInfo) => {
            const percent = Math.round(fileInfo.sent/fileInfo.size*100)
            if(this.blend_chooser.progress != percent) this.blend_chooser.progress = percent;
        });
        uploader.on('complete', fileInfo => {
            this.blend_chooser.uploading = false;
            this.blend_chooser.progress = 0;
            this.blend_chooser.uploads = [];
            this.blend_chooser.blends = null;
            this.$toast.open({
                type:'is-success',
                message:'Uploaded all blend files'
            })
            this.refreshBlendChooser();
        });
        uploader.on('error', function(err) {
            console.log('Error!', err);
        });
        uploader.on('abort', fileInfo => {
            this.blend_chooser.uploading = false;
            this.$dialog.alert({
                title: 'Uploaded has been aborted',
                message: `<b>File Info:</b><br>${JSON.stringify(fileInfo)}`,
                type: 'is-warning',
                hasIcon: true,
                icon: 'alert-circle'
            })
            console.log('Aborted: ', fileInfo);
        });


        socket.on('connect', () => {
            this.socket_status = true;
            console.info("Connected to socket")
        });
        socket.on('stat', (data) => {
            this.stats = data;
        });
        socket.on('log',data => {
            if(data.clear) this.render.logs = "";
            if(data.message) this.render.logs += (data.error?'[ERROR] ':'') + data.message;
            if(data.messages) data.messages.forEach(v =>  this.render.logs += (data.error?'[ERROR] ':'') + v)
            document.getElementById("el_renderlog").scrollTop = document.getElementById("el_renderlog").scrollHeight;
        })
        socket.on('frame',data => {
            this.render.current = data;
            console.log('FRAME:',data)
        })
        socket.on('disconnect', () => {
            this.socket_status = false;
            console.error("Disconnected from socket")
        });

        socket.on('render_start',(d) => {
            this.render.active = true;
            this.render.current = 0;
            this.render.max = d.max_frames;
        })
        socket.on('render_stop',() => {
            this.render.active = false;
        })
    },
    methods:{
        saveDefaults() {
            console.log(this.opts)
            if(window.localStorage) {
                window.localStorage.setItem('blender_opts',JSON.stringify(this.opts))
                this.$toast.open({
                    type:'is-success',
                    message:'Saved defaults'
                })
            }else{
                this.$toast.open({
                    type:'is-danger',
                    message:'Your browser doesn\'t support local storage'
                })
            }
            
        },
        downloadZip(name) {
            axios.get(`zip/${name}/download`).then((data) => {
                download(data, name, "application/blender");
            }).catch(err => {
                this.$toast.open({
                    type:'is-danger',
                    message:'Failed to download zIP'
                })
            })
        },
        deleteZip(name) {
            axios.get(`zip/${name}/delete`).then(r => {
                if(r.data.success) {
                    this.$toast.open({
                        type:'is-success',
                        message:'Deleted zip ' + name
                    })
                    if(r.data.zips) {
                        this.zips.list = r.data.zips;
                    }else{
                        this.refreshZIPs();
                    }
                }else{
                    this.$dialog.alert({
                        title: 'Delete Failed',
                        message: '<b>Server returned:</b> ' + JSON.stringify(r.data),
                        type: 'is-warning',
                        hasIcon: true,
                        icon: 'alert-circle'
                    })
                }
            }).catch(err => {
                console.log(err.data)
                this.$dialog.alert({
                    title: 'Delete Failed',
                    message: '<b>Server returned:</b> ' + err.response?err.response.data.error||JSON.stringify(err.response.data):err.message,
                    type: 'is-danger',
                    hasIcon: true,
                    icon: 'alert-circle'
                })
            })
            
        },
        deleteDropFile(index) {
            this.blend_chooser.uploads.splice(index, 1)
        },
        generateCommand: function() {
            if(!this.blend) return "[No file selected]"
            const type = this.opts.blend.gpu_render?"~/renderGPU.sh":"~/renderCPU.sh";
            const scripts = this.opts.blend.py_scripts.map(v => `-P ${v}`)
            return `${type} "${this.blend}" ${this.opts.blend.all_frames?'all all':`${this.opts.blend.frame_start} ${this.opts.blend.frame_stop}`} ${scripts.join(" ")} ${this.opts.blend.extra_args}`
        },
        uploadFiles() {
            var uploadIds = uploader.upload(this.blend_chooser.uploads, {
                data: { /* Arbitrary data... */ }
            });
            console.log(uploadIds)
        },
        chooseBlend(name) {
            this.blend = name;
            this.blend_chooser.active = false;
        },
        refreshBlendChooser: function() {
            this.blend_chooser.loading = true;
           // if(this.blend_chooser.blends == null) {
                socket.emit('blends',null,res => {
                    this.blend_chooser.loading = false;
                    if(res.error) {
                        this.blend_chooser.active = false;
                        this.$dialog.alert({
                            title: 'Failure',
                            message: 'Could not get a list of blend files<br><strong>Server returned: </strong>' + res.error,
                            type: 'is-danger',
                            hasIcon: true,
                            icon: 'alert-circle'
                        })
                        return;
                    }
                    this.blend_chooser.blends = res.files;
                })
            //}
        },
        refreshZIPs() {
            //if(this.zips.list == null) {
            this.zips.loading = true;
            socket.emit('zips',null,res => {
                this.zips.loading = false;
                if(res.error) {
                    this.zips.active = false;
                    this.$dialog.alert({
                        title: 'Failure',
                        message: 'Could not get a list of zips',
                        type: 'is-danger',
                        hasIcon: true,
                        icon: 'alert-circle'
                    })
                    return;
                }
                this.zips.list = res.files;
            })
            //}
        },
        startRender: function() {
            if(!this.blend) {
                return this.$dialog.alert({
                    title: 'Render Failed',
                    message: 'A valid .blend file was not provided',
                    type: 'is-danger',
                    hasIcon: true,
                    icon: 'alert-circle'
                })
            }
            this.render.logs = "";
            socket.emit('start',{
                blend:this.blend, //need to upload it but sush
                mode:this.opts.blend.gpu_render?'gpu':'cpu',
                frames:(this.opts.blend.all_frames)?null:[this.opts.blend.frame_start,this.opts.blend.frame_stop],
                scripts:this.opts.blend.py_scripts,
                extra_args:this.opts.blend.extra_args
            },res => {
                if(!res) return;
                if(res.error) {
                    return this.$dialog.alert({
                        title: 'Render Failed',
                        message: res.error,
                        type: 'is-danger',
                        hasIcon: true,
                        icon: 'alert-circle'
                    })
                }else{
                    this.$toast.open({
                        type:'is-success',
                        message:'Render has been started.'
                    })
                    console.log("Server Responded: " + JSON.stringify(res))
                }
            })
            
            //this.render.active = true;
        },
        cancelRender: function() {
            socket.emit('cancel',null,res => {
                if(!res.render) {
                    this.$toast.open({
                        type:'is-danger',
                        message:'There is no active renders'
                    })
                }else{
                    this.$toast.open({
                        type:'is-warning',
                        message:'Render has been cancelled'
                    })
                }
            })
            
            //this.render.active = false;
        },
        cm_temp: function(val) {
            if(val===-1) return "n/a";
            if(this.opts.stat.celsius) {
                const c = Math.round((5/9) * (val-32))
                return c+"°C";
            }else{
                return val+"°F";
            }
        },
        cm_vram: function humanFileSize(B,i){var e=i?1e3:1024;if(Math.abs(B)<e)return B+" B";var a=i?["kB","MB","GB","TB","PB","EB","ZB","YB"]:["KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],t=-1;do B/=e,++t;while(Math.abs(B)>=e&&t<a.length-1);return B.toFixed(1)+" "+a[t]}
    }
})
</script>
</body>
</html>

